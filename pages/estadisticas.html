<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Sabbatini</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            padding: 20px;
            max-width: 1300px;
            min-width: 1300px;
        }

        .container {

            max-width: 1300px;
            min-width: 1300px;
            margin: 30px auto;
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .anuncio {
            display: flex;
            justify-content: center;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 116, 139, 0.5);
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }

        h1 {
            text-align: center;
            color: #1e293b;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .indice {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #1e40af;
        }

        .indice h2 {
            color: #1e293b;
            font-size: 20px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .indice-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .indice-link {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .indice-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
        }

        html {
            scroll-behavior: smooth;
        }

        .categoria-section {
            margin-bottom: 50px;
            scroll-margin-top: 20px;
        }

        .categoria-header {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 16px;
            text-align: center;
            font-weight: 700;
            font-size: 24px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            margin-bottom: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 2px solid #1e40af;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 12px;
            margin: -20px -20px 15px -20px;
            border-radius: 10px 10px 0 0;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ganadores-list {
            display: grid;
            gap: 8px;
        }

        .ganador-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 6px;
            border-left: 3px solid #fbbf24;
        }

        .ganador-tramo {
            font-weight: 600;
            color: #1e293b;
        }

        .ganador-nombre {
            color: #475569;
        }

        .lideres-timeline {
            display: grid;
            gap: 10px;
        }

        .lider-periodo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            border-left: 4px solid #1e40af;
        }

        .lider-pes {
            font-weight: 700;
            color: #1e293b;
            min-width: 80px;
        }

        .lider-nombre {
            color: #475569;
            font-weight: 600;
        }

        .abandonos-info {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }

        .abandono-stat {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .abandono-numero {
            font-size: 48px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 5px;
        }

        .abandono-label {
            font-size: 14px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .last-update {
            text-align: center;
            color: #64748b;
            font-size: 13px;
            margin-top: 25px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        /* Media Queries para Responsive */
        @media (max-width: 1024px) {
            .stats-grid {
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
                margin: 5px auto;
                border-radius: 8px;
            }

            .btn-back {
                /* padding: 8px 12px; */
                margin-bottom: 10px;
            }

            h1 {
                margin-bottom: 15px;
            }

            .indice {
                padding: 10px;
            }
/* 
            .indice h2 {
                font-size: 16px;
                margin-bottom: 10px;
            } */

            .indice-links {
                gap: 8px;
            }

            /* .indice-link {
                padding: 8px 12px;
                font-size: 12px; 
            } */

            .categoria-header {
                /* font-size: 18px; */
                padding: 10px;
                margin-bottom: 15px;
            }

            .categoria-section {
                margin-bottom: 30px;
            }

            .stats-grid {
                /* grid-template-columns: 1fr; */
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h3 {
                /* font-size: 14px; */
                padding: 10px;
                margin: -15px -15px 12px -15px;
            }

            .ganador-item {
                padding: 8px;
                /* font-size: 12px; */
            }

            /* .lider-periodo {
                padding: 10px;
                font-size: 12px;
            } */

            /* .lider-pes {
                min-width: 60px;
                font-size: 12px;
            } */

            .abandonos-info {
                /* flex-direction: column; */
                gap: 10px;
            }

            .abandono-stat {
                padding: 15px;
            }

            /* .abandono-numero {
                font-size: 36px;
            } */

            /* .abandono-label {
                font-size: 12px;
            } */

            .chart-container {
                height: 300px;
            }

            /* .last-update {
                font-size: 10px;
                padding: 10px;
            } */
        }

        @media (max-width: 480px) {
            /* h1 {
                font-size: 20px;
            } */

            /* .categoria-header {
                font-size: 16px;
                padding: 8px;
            } */

            /* .btn-back {
                padding: 6px 10px;
                font-size: 10px;
            } */

            /* .indice h2 {
                font-size: 14px;
            } */

            /* .indice-link {
                padding: 6px 10px;
                font-size: 11px;
            } */

            /* .stat-card h3 {
                font-size: 12px;
            } */

            /* .ganador-item,
            .lider-periodo {
                font-size: 11px;
            } */

            /* .abandono-numero {
                font-size: 28px;
            } */

            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/index.html" class="btn-back">
            <span>‚Üê</span>
            <span>Volver al Men√∫</span>
        </a>

        <h1>ESTAD√çSTICAS DEL RALLY</h1>

        <div class="indice">
            <h2>√çndice de Categor√≠as</h2>
            <div class="indice-links" id="indiceLinks"></div>
        </div>

        <div id="content" class="loading">Cargando estad√≠sticas</div>
        <div class="last-update" id="lastUpdate"></div>
    </div>
    <div class="anuncio">
        <script type="text/javascript">
            atOptions = {
                'key' : '43228b318a2a8ae3c5aa2d56930ee759',
                'format' : 'iframe',
                'height' : 90,
                'width' : 728,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/43228b318a2a8ae3c5aa2d56930ee759/invoke.js"></script>
    </div>

    <script>
        const PILOTOS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeo0wYsc5ti8yBhljZLKklf7VXplQSmbAQS3GtdGokmvwQcj7X7QVGOX9h3jTh045B5O8vr6jb2G7U/pub?gid=1122371230&single=true&output=csv';
        const TRAMOS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeo0wYsc5ti8yBhljZLKklf7VXplQSmbAQS3GtdGokmvwQcj7X7QVGOX9h3jTh045B5O8vr6jb2G7U/pub?gid=0&single=true&output=csv';

        let pilotosData = [];
        let tramosData = [];
        let categorias = [];

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                data.push(obj);
            }
            
            return data;
        }

        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === '') return 999999;
            
            timeStr = timeStr.trim().replace(/[,]/, '.');
            const parts = timeStr.split(':');
            
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            } else if (parts.length === 3) {
                return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2]);
            }
            return 999999;
        }

        function calcularTotalAcumulado(piloto, hastaPE) {
            let totalSegundos = 0;
            
            for (let i = 1; i <= hastaPE; i++) {
                const ssColumn = `SS${i}`;
                const tiempo = piloto[ssColumn];
                
                if (!tiempo || tiempo === '') {
                    return 999999;
                }
                
                const segundos = timeToSeconds(tiempo);
                if (segundos >= 999999) {
                    return 999999;
                }
                
                totalSegundos += segundos;
            }
            
            return totalSegundos;
        }

        function obtenerGanadoresPorTramo(categoria) {
            const ganadores = [];
            const numTramos = tramosData.length;
            
            for (let pe = 1; pe <= numTramos; pe++) {
                const ssColumn = `SS${pe}`;
                const pilotosCategoria = pilotosData.filter(p => 
                    (p.Categoria || p.CATEGORIA) === categoria && 
                    p[ssColumn] && 
                    p[ssColumn] !== ''
                );
                
                if (pilotosCategoria.length === 0) continue;
                
                let mejorPiloto = null;
                let mejorTiempo = 999999;
                
                pilotosCategoria.forEach(piloto => {
                    const tiempo = timeToSeconds(piloto[ssColumn]);
                    if (tiempo < mejorTiempo) {
                        mejorTiempo = tiempo;
                        mejorPiloto = piloto.Nombre || piloto.NOMBRE || '';
                    }
                });
                
                if (mejorPiloto) {
                    ganadores.push({
                        pe: pe,
                        nombre: mejorPiloto
                    });
                }
            }
            
            // Agrupar ganadores consecutivos
            const ganadoresAgrupados = [];
            let ganadorActual = null;
            let peInicio = 1;
            
            ganadores.forEach((ganador, index) => {
                if (ganadorActual === null) {
                    ganadorActual = ganador.nombre;
                    peInicio = ganador.pe;
                } else if (ganador.nombre !== ganadorActual || ganador.pe !== ganadores[index - 1].pe + 1) {
                    ganadoresAgrupados.push({
                        peInicio: peInicio,
                        peFin: ganadores[index - 1].pe,
                        nombre: ganadorActual
                    });
                    ganadorActual = ganador.nombre;
                    peInicio = ganador.pe;
                }
            });
            
            if (ganadorActual && ganadores.length > 0) {
                ganadoresAgrupados.push({
                    peInicio: peInicio,
                    peFin: ganadores[ganadores.length - 1].pe,
                    nombre: ganadorActual
                });
            }
            
            return ganadoresAgrupados;
        }

        function obtenerLideresGenerales(categoria) {
            const numTramos = tramosData.length;
            const lideres = [];
            let liderActual = null;
            let peInicio = 1;
            
            for (let pe = 1; pe <= numTramos; pe++) {
                const pilotosCategoria = pilotosData
                    .filter(p => (p.Categoria || p.CATEGORIA) === categoria)
                    .map(p => ({
                        nombre: p.Nombre || p.NOMBRE || '',
                        totalSegundos: calcularTotalAcumulado(p, pe)
                    }))
                    .filter(p => p.totalSegundos < 999999)
                    .sort((a, b) => a.totalSegundos - b.totalSegundos);
                
                if (pilotosCategoria.length === 0) continue;
                
                const nuevoLider = pilotosCategoria[0].nombre;
                
                if (liderActual === null) {
                    liderActual = nuevoLider;
                    peInicio = pe;
                } else if (nuevoLider !== liderActual) {
                    lideres.push({
                        peInicio: peInicio,
                        peFin: pe - 1,
                        nombre: liderActual
                    });
                    liderActual = nuevoLider;
                    peInicio = pe;
                }
            }
            
            if (liderActual) {
                lideres.push({
                    peInicio: peInicio,
                    peFin: numTramos,
                    nombre: liderActual
                });
            }
            
            return lideres;
        }

        function calcularAbandonos(categoria) {
            const pilotosCategoria = pilotosData.filter(p => 
                (p.Categoria || p.CATEGORIA) === categoria
            );
            
            const numTramos = tramosData.length;
            let largados = 0;
            let abandonos = 0;
            
            pilotosCategoria.forEach(piloto => {
                const tieneAlgunTiempo = piloto.SS1 && piloto.SS1 !== '';
                
                if (tieneAlgunTiempo) {
                    largados++;
                    
                    const totalFinal = calcularTotalAcumulado(piloto, numTramos);
                    if (totalFinal >= 999999) {
                        abandonos++;
                    }
                }
            });
            
            return { largados, abandonos };
        }

        function generarGraficoEvolucion(categoria) {
            const numTramos = tramosData.length;
            const pilotosCategoria = pilotosData.filter(p => 
                (p.Categoria || p.CATEGORIA) === categoria
            );
            
            // Calcular posiciones por PE
            const evolucionPosiciones = {};
            const pilotosEnTop5 = new Set(); // Pilotos que alguna vez estuvieron en top 5
            
            for (let pe = 1; pe <= numTramos; pe++) {
                const clasificacion = pilotosCategoria
                    .map(p => ({
                        nombre: p.Nombre || p.NOMBRE || '',
                        totalSegundos: calcularTotalAcumulado(p, pe)
                    }))
                    .filter(p => p.totalSegundos < 999999)
                    .sort((a, b) => a.totalSegundos - b.totalSegundos);
                
                clasificacion.forEach((piloto, index) => {
                    if (!evolucionPosiciones[piloto.nombre]) {
                        evolucionPosiciones[piloto.nombre] = [];
                    }
                    evolucionPosiciones[piloto.nombre].push({
                        pe: pe,
                        posicion: index + 1
                    });
                    
                    // Marcar pilotos que estuvieron en top 5
                    if (index < 5) {
                        pilotosEnTop5.add(piloto.nombre);
                    }
                });
            }
            
            // Solo incluir pilotos que alguna vez estuvieron en el top 5
            const todosPilotos = Array.from(pilotosEnTop5);
            
            // Calcular cu√°ntos PE cada piloto estuvo en top 5 (para ordenar)
            const pesEnTop5 = {};
            todosPilotos.forEach(nombre => {
                const datos = evolucionPosiciones[nombre] || [];
                pesEnTop5[nombre] = datos.filter(d => d.posicion <= 5).length;
            });
            
            // Ordenar por cantidad de veces en top 5 (descendente)
            todosPilotos.sort((a, b) => pesEnTop5[b] - pesEnTop5[a]);
            
            return {
                evolucionPosiciones,
                todosPilotos: todosPilotos,
                pesEnTop5: pesEnTop5
            };
        }

        function crearGrafico(canvasId, categoria, datosEvolucion) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const numTramos = tramosData.length;
            const labels = Array.from({length: numTramos}, (_, i) => `PE${i + 1}`);
            
            const colores = [
                '#1e40af', '#dc2626', '#059669', '#d97706', '#7c3aed',
                '#0891b2', '#e11d48', '#65a30d', '#ea580c', '#a855f7',
                '#0284c7', '#be123c', '#4d7c0f', '#c2410c', '#7e22ce',
                '#0369a1', '#9f1239', '#3f6212', '#9a3412', '#6b21a8'
            ];
            
            // Validar que todosPilotos exista y sea un array
            if (!datosEvolucion || !datosEvolucion.todosPilotos || !Array.isArray(datosEvolucion.todosPilotos)) {
                console.error('Datos de evoluci√≥n inv√°lidos:', datosEvolucion);
                return;
            }
            
            const datasets = datosEvolucion.todosPilotos.map((nombre, index) => {
                const datos = datosEvolucion.evolucionPosiciones[nombre] || [];
                const dataPoints = Array(numTramos).fill(null);
                
                // Solo agregar puntos cuando el piloto est√° en top 5
                datos.forEach(d => {
                    if (d.posicion <= 5) {
                        dataPoints[d.pe - 1] = d.posicion;
                    }
                });
                
                // Mostrar por defecto solo los primeros 5
                const esVisible = index < 5;
                
                return {
                    label: nombre,
                    data: dataPoints,
                    borderColor: colores[index % colores.length],
                    backgroundColor: colores[index % colores.length],
                    tension: 0.3,
                    borderWidth: esVisible ? 3 : 2,
                    pointRadius: esVisible ? 4 : 2,
                    pointHoverRadius: 6,
                    hidden: !esVisible,
                    spanGaps: false // NO conectar cuando hay gaps
                };
            });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true,
                            beginAtZero: false,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + '¬∫';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Posici√≥n'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Prueba Especial'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                
                                meta.hidden = !meta.hidden;
                                ci.update();
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '¬∫';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderEstadisticas() {
            if (pilotosData.length === 0 || tramosData.length === 0) {
                document.getElementById('content').innerHTML = 
                    '<div class="error">‚ùå No se encontraron datos.</div>';
                return;
            }

            categorias = [...new Set(pilotosData.map(p => p.Categoria || p.CATEGORIA))].filter(c => c).sort();

            // Crear √≠ndice
            let indiceHTML = '';
            categorias.forEach(cat => {
                const catId = cat.replace(/\s+/g, '-').toLowerCase();
                indiceHTML += `<a class="indice-link" href="#${catId}">${cat}</a>`;
            });
            document.getElementById('indiceLinks').innerHTML = indiceHTML;

            // Crear secciones por categor√≠a
            let html = '';
            
            categorias.forEach(categoria => {
                const catId = categoria.replace(/\s+/g, '-').toLowerCase();
                const ganadores = obtenerGanadoresPorTramo(categoria);
                const lideres = obtenerLideresGenerales(categoria);
                const { largados, abandonos } = calcularAbandonos(categoria);
                const datosEvolucion = generarGraficoEvolucion(categoria);
                
                html += `
                    <div class="categoria-section" id="${catId}">
                        <div class="categoria-header">${categoria}</div>
                        
                        <div class="stats-grid">
                            <!-- Ganadores de Tramos -->
                            <div class="stat-card">
                                <h3>üèÜ Ganadores por Tramo</h3>
                                <div class="ganadores-list">
                `;
                
                ganadores.forEach(g => {
                    const peRange = g.peInicio === g.peFin 
                        ? `PE${g.peInicio}` 
                        : `PE${g.peInicio}-${g.peFin}`;
                    
                    html += `
                        <div class="ganador-item">
                            <span class="ganador-tramo">${peRange}</span>
                            <span class="ganador-nombre">${g.nombre}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                            
                            <!-- L√≠deres Generales -->
                            <div class="stat-card">
                                <h3>üèÜ LIDERES DE LA GENERAL</h3>
                                <div class="lideres-timeline">
                `;
                
                lideres.forEach(l => {
                    const peRange = l.peInicio === l.peFin 
                        ? `PE${l.peInicio}` 
                        : `PE${l.peInicio}-${l.peFin}`;
                    
                    html += `
                        <div class="lider-periodo">
                            <span class="lider-pes">${peRange}</span>
                            <span class="lider-nombre">${l.nombre}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                        
                        <!-- Abandonos -->
                        <div class="stat-card">
                            <h3>üìä Participaci√≥n</h3>
                            <div class="abandonos-info">
                                <div class="abandono-stat">
                                    <div class="abandono-numero">${largados}</div>
                                    <div class="abandono-label">Largaron</div>
                                </div>
                                <div class="abandono-stat">
                                    <div class="abandono-numero">${abandonos}</div>
                                    <div class="abandono-label">Abandonos</div>
                                </div>
                                <div class="abandono-stat">
                                    <div class="abandono-numero">${largados - abandonos}</div>
                                    <div class="abandono-label">Finalizaron</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico de Evoluci√≥n -->
                        <div class="stat-card">
                            <h3>üìà Evoluci√≥n Top 5 - Posici√≥n General</h3>
                            <div class="chart-container">
                                <canvas id="chart-${catId}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('content').innerHTML = html;

            // Crear gr√°ficos despu√©s de renderizar el HTML
            categorias.forEach(categoria => {
                const catId = categoria.replace(/\s+/g, '-').toLowerCase();
                const datosEvolucion = generarGraficoEvolucion(categoria);
                
                // Validar que los datos sean correctos antes de crear el gr√°fico
                if (datosEvolucion && datosEvolucion.todosPilotos && datosEvolucion.todosPilotos.length > 0) {
                    crearGrafico(`chart-${catId}`, categoria, datosEvolucion);
                } else {
                    console.warn(`No hay datos suficientes para crear gr√°fico de ${categoria}`);
                }
            });
        }

        async function loadData() {
            try {
                const [pilotosResponse, tramosResponse] = await Promise.all([
                    fetch(PILOTOS_URL),
                    fetch(TRAMOS_URL)
                ]);
                
                const pilotosText = await pilotosResponse.text();
                const tramosText = await tramosResponse.text();
                
                pilotosData = parseCSV(pilotosText);
                tramosData = parseCSV(tramosText);
                
                renderEstadisticas();
                updateLastUpdate();
            } catch (error) {
                document.getElementById('content').innerHTML = 
                    '<div class="error">‚ö†Ô∏è Error al cargar los datos.</div>';
                console.error('Error:', error);
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-AR');
            document.getElementById('lastUpdate').textContent = 
                `üîÑ √öltima actualizaci√≥n: ${timeStr}`;
        }

        loadData();
        setInterval(loadData, 120000); // Actualiza cada 2 minutos
    </script>
</body>
</html>