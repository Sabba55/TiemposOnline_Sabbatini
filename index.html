<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/index.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9744418770114604" crossorigin="anonymous"></script>
    <title>Pagina de tiempos - Sabbatini</title>
</head>

<body>
    <div class="header-banner">
        <div class="header-content">
            <div class="header-title-wrapper">
                <div class="header-title">Pagina de tiempos - Sabbatini</div>
                <div class="header-subtitle">Sistema de Seguimiento en Tiempo Real | Creado por Sabbatini Martin</div>
            </div>
            <div class="logo-container">
                <img src="assets/logoSabbatini.png" alt="Rally Logo">
            </div>
        </div>
    </div>

    <div class="anuncio"></div>

    <div class="container">
        <div class="buttonContainer">
            <button class="btn-clases">
                INSCRIPTOS
            </button>
            <button class="btn-clases" onclick="window.location.href='ordenLargada.html'">
                ORDEN DE LARGADA
            </button>
        </div>
        <div id="content" class="loading">Cargando datos</div>
        <div class="last-update" id="lastUpdate"></div>
    </div>

    <div class="anuncio"></div>

    <script>
        const TRAMOS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeo0wYsc5ti8yBhljZLKklf7VXplQSmbAQS3GtdGokmvwQcj7X7QVGOX9h3jTh045B5O8vr6jb2G7U/pub?gid=0&single=true&output=csv';
        const PILOTOS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeo0wYsc5ti8yBhljZLKklf7VXplQSmbAQS3GtdGokmvwQcj7X7QVGOX9h3jTh045B5O8vr6jb2G7U/pub?gid=1122371230&single=true&output=csv';
        
        let tramosData = [];
        let pilotosData = [];

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                data.push(obj);
            }
            
            return data;
        }

        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === '') return 999999;
            
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            } else if (parts.length === 3) {
                return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2]);
            }
            return 999999;
        }

        function obtenerGanadorPE(peNumber) {
            const ssColumn = `SS${peNumber}`;
            let mejorPiloto = null;
            let mejorTiempo = 999999;

            pilotosData.forEach(piloto => {
                const tiempo = piloto[ssColumn];
                if (tiempo && tiempo !== '') {
                    const segundos = timeToSeconds(tiempo);
                    if (segundos < mejorTiempo) {
                        mejorTiempo = segundos;
                        mejorPiloto = {
                            nombre: piloto.Nombre || piloto.NOMBRE || '',
                            tiempo: tiempo
                        };
                    }
                }
            });

            return mejorPiloto;
        }

        function validarConsistenciaDatos() {
            // Contar cu√°ntos PE hay en tramosData
            const numeroPEs = tramosData.length;
            
            // Contar cu√°ntas columnas SS hay en pilotosData
            if (pilotosData.length === 0) {
                return { valido: false, mensaje: 'No hay datos de pilotos' };
            }
            
            const primeraFila = pilotosData[0];
            const columnasSS = Object.keys(primeraFila).filter(key => key.match(/^SS\d+$/));
            const numeroSS = columnasSS.length;
            
            if (numeroPEs !== numeroSS) {
                return {
                    valido: false,
                    mensaje: `‚ö†Ô∏è INCONSISTENCIA DE DATOS: ‚ö†Ô∏è\n\n` +
                            `‚Ä¢ PE en tabla de Tramos: ${numeroPEs}\n` +
                            `‚Ä¢ Columnas SS en tabla de Pilotos: ${numeroSS}\n\n` +
                            `El n√∫mero de PE debe coincidir con el n√∫mero de columnas SS en la tabla de pilotos.\n` +
                            `Por favor, no seas boludo y corregi las hojas de c√°lculo.`
                };
            }
            
            return { valido: true };
        }

        async function loadData() {
            try {
                const [tramosResponse, pilotosResponse] = await Promise.all([
                    fetch(TRAMOS_URL),
                    fetch(PILOTOS_URL)
                ]);
                
                const tramosText = await tramosResponse.text();
                const pilotosText = await pilotosResponse.text();
                
                tramosData = parseCSV(tramosText);
                pilotosData = parseCSV(pilotosText);
                
                // Validar consistencia de datos
                const validacion = validarConsistenciaDatos();
                if (!validacion.valido) {
                    alert(validacion.mensaje);
                    document.getElementById('content').innerHTML = 
                        '<div class="error"> ' + validacion.mensaje.replace(/\n/g, '<br>') + '</div>';
                    return;
                }
                
                renderMenu();
                updateLastUpdate();
            } catch (error) {
                document.getElementById('content').innerHTML = 
                    '<div class="error">‚ö†Ô∏è Error al cargar los datos. Por favor, verifica que la hoja de c√°lculo est√© publicada correctamente.</div>';
                console.error('Error:', error);
            }
        }

        function renderMenu() {
            if (tramosData.length === 0) {
                document.getElementById('content').innerHTML = 
                    '<div class="error">‚ùå No se encontraron datos de tramos.</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>PE</th>
                            <th>Desde - Hasta</th>
                            <th>KMS</th>
                            <th>Hora</th>
                            <th>Clases</th>
                            <th>Ganador</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            tramosData.forEach(tramo => {
                const pe = tramo.PE || '';
                const desde = tramo.Desde || '';
                const hasta = tramo.Hasta || '';
                const desdeHasta = desde && hasta ? `${desde} - ${hasta}` : '';
                const kms = tramo.KMS || '';
                const hora = tramo.HORA || '';

                const ganador = obtenerGanadorPE(pe);
                let ganadorHTML = '-';
                
                if (ganador) {
                    ganadorHTML = `
                        <div>${ganador.nombre}</div>
                        <span class="ganador-tiempo">${ganador.tiempo}</span>
                    `;
                }

                html += `
                    <tr>
                        <td><span class="pe-number">${pe}</span></td>
                        <td>${desdeHasta}</td>
                        <td><strong>${kms}</strong></td>
                        <td>${hora}</td>
                        <td>
                            <button class="btn-clases" onclick="verClases('${pe}')">
                                Ver Resultados
                            </button>
                        </td>
                        <td class="ganador-cell">${ganadorHTML}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('content').innerHTML = html;
        }

        function verClases(pe) {
            window.location.href = `tramo.html?pe=${pe}`;
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-AR');
            document.getElementById('lastUpdate').textContent = 
                `üîÑ √öltima actualizaci√≥n: ${timeStr}`;
        }

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>